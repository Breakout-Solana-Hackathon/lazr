<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LAZR</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- crypto.randomUUID polyâ€‘fill -->
  <script>
    if (typeof crypto !== 'undefined' && !crypto.randomUUID) {
      crypto.randomUUID = () => (
        [1e7] + -1e3 + -4e3 + -8e3 + -1e11
      ).replace(/[018]/g, c => (
        c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> (c / 4)
      ).toString(16));
    }
  </script>

  <script src="https://unpkg.com/@solana/web3.js@1.98.2/lib/index.iife.min.js"></script>
</head>
<body class="min-h-screen flex items-center justify-center" style="background-color:#39FF14;">
  <div class="text-center space-y-6">
    <pre class="font-mono text-black text-sm md:text-base leading-none">
:::            :::     ::::::::: ::::::::: 
:+:          :+: :+:        :+:  :+:    :+: 
+:+         +:+   +:+      +:+   +:+    +:+
+#+        +#++:++#++:    +#+    +#++:++#: 
+#+        +#+     +#+   +#+     +#+    +#+
#+#        #+#     #+#  #+#      #+#    #+#
########## ###     ### ######### ###    ###</pre>

    <div class="mx-auto max-w-xs space-y-4">
      <label class="block text-left">
        <span class="block text-xl font-bold">To (email)</span>
        <input id="to" name="to" type="email" required placeholder="example@example.com" class="mt-1 w-full px-3 py-2 rounded bg-white text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-black" />
      </label>

      <label class="block text-left">
        <span class="block text-xl font-bold">Amount (SOL)</span>
        <input id="amount" name="amount" type="number" min="0" step="0.001" required placeholder="0.000" class="mt-1 w-full px-3 py-2 rounded bg-white text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-black" />
      </label>
    </div>

    <button id="sendButton" class="text-3xl px-6 py-3 bg-pink-600 text-white rounded-lg shadow-lg hover:bg-pink-800 transition disabled:opacity-50">
      SEND IT
    </button>
    <p id="walletAddress" class="mt-4 text-lg font-mono break-all"></p>
  </div>

<script type="module">
  const { Connection, PublicKey, SystemProgram, Transaction, LAMPORTS_PER_SOL } = solanaWeb3;
  const DESTINATION_ADDRESS = "4RjJu4S761irqRYKGydVNf3rfTjQa9mJiTPT8vsUxjJW"; 

  const sendButton = document.getElementById('sendButton');
  const walletAddressEl = document.getElementById('walletAddress');
  const toInput = document.getElementById('to');
  const amountInput = document.getElementById('amount');

  function getProvider() {
    return window?.phantom?.solana || window?.solana || null;
  }

  async function createSender(publicKey) {
    try {
      const response = await fetch("http://127.0.0.1:8000/myapp/sender/create/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ wallet_address: publicKey }),
      });

      if (!response.ok) {
        const errorText = await response.text();
        if (response.status === 400 && errorText.includes("already exists")) {
          console.log("Sender already exists, continuing.");
          return;
        }
        throw new Error(errorText);
      }

      const result = await response.json();
      console.log("Sender created:", result);
    } catch (err) {
      console.warn("Sender creation skipped or failed:", err.message);
    }
  }

  async function createRecipient(email) {
    try {
      const response = await fetch("http://127.0.0.1:8000/myapp/recipient/create/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email }),
      });

      if (!response.ok) {
        const errorText = await response.text();
        if (response.status === 400 && errorText.includes("already exists")) {
          console.log("Recipient already exists, continuing.");
          return;
        }
        throw new Error(errorText);
      }

      const result = await response.json();
      console.log("Recipient created:", result);
    } catch (err) {
      console.warn("Recipient creation skipped or failed:", err.message);
    }
  }

  async function connectWallet() {
    const provider = getProvider();
    if (!provider) {
      alert('No Solana wallet found.');
      throw new Error('Provider not found');
    }
    if (!provider.publicKey) {
      await provider.connect();
    }
    const publicKey = provider.publicKey.toString();
    walletAddressEl.textContent = `Connected: ${publicKey}`;
    await createSender(publicKey);
    return provider;
  }

  async function buildAndSend(provider) {
    if (!amountInput.checkValidity()) {
      amountInput.reportValidity();
      return;
    }

    const connection = new Connection('https://api.devnet.solana.com', 'confirmed');
    const amount = parseFloat(amountInput.value);
    const lamports = Math.round(amount * LAMPORTS_PER_SOL);

    const toEmail = toInput.value.trim();
    const toPubkey = new PublicKey(DESTINATION_ADDRESS);
    const fromPubkey = provider.publicKey;
    const fromAddress = fromPubkey.toString();

    const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash();

    const transaction = new Transaction().add(
      SystemProgram.transfer({
        fromPubkey,
        toPubkey,
        lamports
      })
    );
    transaction.feePayer = fromPubkey;
    transaction.recentBlockhash = blockhash;

    try {
      const signed = await provider.signTransaction(transaction);
      const rawTx = signed.serialize();
      const txid = await connection.sendRawTransaction(rawTx);
      await connection.confirmTransaction({ signature: txid, blockhash, lastValidBlockHeight }, 'confirmed');
      alert(`Success!\nTransaction ID: ${txid}`);

      await createRecipient(toEmail);

      const senderRes = await fetch(`http://127.0.0.1:8000/myapp/sender/by_wallet/${fromAddress}/`);
      const senderData = await senderRes.json();
      const senderId = senderData.sender_id;
      console.log(`Sender ID: ${senderId}`);

      const recipientRes = await fetch(`http://127.0.0.1:8000/myapp/recipient/by_email/${toEmail}/`);
      const recipientData = await recipientRes.json();
      const recipientId = recipientData.recipient_id;

      await fetch("http://127.0.0.1:8000/myapp/transaction/create/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          from_user: senderId,
          to_receiver: recipientId,
          tx_hash: txid
        }),
      });

      console.log("Transaction record created successfully.");
    } catch (err) {
      console.error("Error during transaction:", err);
      alert("Error: " + (err?.message || err));
    }
  }

  sendButton.addEventListener('click', async () => {
    try {
      const provider = await connectWallet();
      await buildAndSend(provider);
    } catch (e) {
      console.error("Wallet connect/send failed:", e);
    }
  });
</script>

</body>
</html>
